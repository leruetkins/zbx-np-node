<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zbx-np Admin Panel</title>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        [v-cloak] {
            display: none;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Ensure full height layout without scrolling */
        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        #app {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak class="h-full bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
        <!-- Login Form -->
        <div v-if="!isAuthenticated" class="h-full flex items-center justify-center px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div class="text-center">
                    <i class="fas fa-server text-4xl text-blue-600 dark:text-blue-400 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white">zbx-np</h2>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Admin Panel</p>
                </div>

                <form @submit.prevent="handleLogin" class="mt-8 space-y-6">
                    <div class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                            <input id="username" v-model="loginForm.username" type="text" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Enter username" />
                        </div>

                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                            <input id="password" v-model="loginForm.password" type="password" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Enter password" />
                        </div>
                    </div>

                    <div v-if="loginError" class="text-red-600 dark:text-red-400 text-sm text-center">
                        {{ loginError }}
                    </div>

                    <div>
                        <button type="submit" :disabled="isLoggingIn"
                            class="w-full py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
                            <span v-if="isLoggingIn" class="mr-2">
                                <i class="fas fa-spinner fa-spin"></i>
                            </span>
                            {{ isLoggingIn ? 'Signing in...' : 'Sign in' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Main Application -->
        <div v-else class="h-full flex flex-col overflow-hidden bg-gray-50 dark:bg-gray-900">
            <!-- Top Navigation -->
            <nav class="flex-shrink-0 bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 h-16 relative z-30">
                <div class="w-full px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <!-- Mobile menu button -->
                            <button @click="sidebarOpen = !sidebarOpen"
                                class="lg:hidden p-2 rounded-md text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 mr-3">
                                <i :class="sidebarOpen ? 'fas fa-times' : 'fas fa-bars'" class="text-lg"></i>
                            </button>

                            <i class="fas fa-server text-2xl text-blue-600 dark:text-blue-400 mr-3"></i>
                            <h1 class="text-xl font-semibold text-gray-900 dark:text-white">zbx-np Admin</h1>
                        </div>

                        <div class="flex items-center space-x-4">
                            <!-- WebSocket Status -->
                            <div class="hidden sm:flex items-center space-x-2">
                                <div :class="['w-2 h-2 rounded-full', wsConnected ? 'bg-green-500' : 'bg-red-500']"></div>
                                <span class="text-sm text-gray-600 dark:text-gray-400">
                                    {{ wsConnected ? 'Connected' : 'Disconnected' }}
                                </span>
                            </div>

                            <!-- Dark Mode Toggle -->
                            <button @click="toggleDarkMode" class="p-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
                                <i :class="darkMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
                            </button>

                            <!-- User Menu -->
                            <div class="relative" ref="userMenuContainer">
                                <button @click="toggleUserMenu" class="flex items-center space-x-2 text-sm text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                                    <i class="fas fa-user-circle text-lg"></i>
                                    <span class="hidden sm:inline">{{ user?.username || 'User' }}</span>
                                    <i :class="['fas transition-transform duration-200', showUserMenu ? 'fa-chevron-up' : 'fa-chevron-down', 'text-xs']"></i>
                                </button>

                                <transition name="fade">
                                    <div v-if="showUserMenu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-50 border border-gray-200 dark:border-gray-700">
                                        <button @click="logout"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200">
                                            <i class="fas fa-sign-out-alt mr-2"></i>
                                            Logout
                                        </button>
                                    </div>
                                </transition>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <div class="flex flex-1 min-h-0 overflow-hidden">
                <!-- Mobile Sidebar Overlay -->
                <div v-if="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 z-20 bg-black bg-opacity-50 lg:hidden"></div>

                <!-- Sidebar -->
                <aside :class="[
                        'fixed lg:static top-16 lg:top-0 bottom-0 lg:bottom-auto left-0 z-30 w-64 bg-white dark:bg-gray-800 shadow-sm transform transition-transform duration-200 ease-in-out lg:translate-x-0 lg:block',
                        sidebarOpen ? 'translate-x-0' : '-translate-x-full'
                    ]" class="overflow-y-auto flex-shrink-0 lg:h-full">
                    <nav class="mt-5 px-2">
                        <div class="space-y-1">
                            <button v-for="item in navigation" :key="item.name" @click="currentView = item.key; sidebarOpen = false" :class="[
                                    'group flex items-center px-2 py-2 text-base font-medium rounded-md w-full text-left',
                                    currentView === item.key
                                        ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200'
                                        : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'
                                ]">
                                <i :class="[item.icon, 'mr-3 text-lg']"></i>
                                {{ item.name }}
                            </button>
                        </div>
                    </nav>
                </aside>

                <!-- Content Area -->
                <main class="flex-1 flex flex-col min-h-0 overflow-hidden">
                    <!-- Dashboard View -->
                    <div v-show="currentView === 'dashboard'" class="flex flex-col h-full overflow-hidden">
                        <!-- Header Section -->
                        <div class="flex-shrink-0 p-4 lg:p-6">
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h2>
                                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Monitor your zbx-np service</p>
                            </div>

                            <!-- Stats Cards -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 lg:gap-6 mb-6">
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900">
                                            <i class="fas fa-server text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Requests</p>
                                            <p class="text-xl lg:text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.total_requests || 0 }}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                                            <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Successful</p>
                                            <p class="text-xl lg:text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.successful_requests || 0 }}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-red-100 dark:bg-red-900">
                                            <i class="fas fa-times-circle text-red-600 dark:text-red-400"></i>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Failed</p>
                                            <p class="text-xl lg:text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.failed_requests || 0 }}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full" :class="{
                                            'bg-green-100 dark:bg-green-900': mqttStatus.status === 'running',
                                            'bg-yellow-100 dark:bg-yellow-900': mqttStatus.status === 'starting' || mqttStatus.status === 'connecting' || mqttStatus.status === 'reconnecting',
                                            'bg-gray-100 dark:bg-gray-900': mqttStatus.status === 'disabled' || mqttStatus.status === 'stopped',
                                            'bg-red-100 dark:bg-red-900': mqttStatus.status === 'unknown' || mqttStatus.status === 'error' || mqttStatus.status === 'disconnected'
                                        }">
                                            <i class="fas fa-wifi" :class="{
                                                'text-green-600 dark:text-green-400': mqttStatus.status === 'running',
                                                'text-yellow-600 dark:text-yellow-400': mqttStatus.status === 'starting' || mqttStatus.status === 'connecting' || mqttStatus.status === 'reconnecting',
                                                'text-gray-600 dark:text-gray-400': mqttStatus.status === 'disabled' || mqttStatus.status === 'stopped',
                                                'text-red-600 dark:text-red-400': mqttStatus.status === 'unknown' || mqttStatus.status === 'error' || mqttStatus.status === 'disconnected'
                                            }"></i>
                                        </div>
                                        <div class="ml-4 min-w-0 flex-1">
                                            <div class="flex items-center justify-between">
                                                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">MQTT Status</p>
                                                <div class="flex items-center space-x-1">
                                                    <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse" title="Real-time via WebSocket"></div>
                                                </div>
                                            </div>
                                            <p class="text-sm lg:text-lg font-semibold truncate" :class="{
                                                'text-green-600 dark:text-green-400': mqttStatus.status === 'running',
                                                'text-yellow-600 dark:text-yellow-400': mqttStatus.status === 'starting' || mqttStatus.status === 'connecting' || mqttStatus.status === 'reconnecting',
                                                'text-gray-600 dark:text-gray-400': mqttStatus.status === 'disabled' || mqttStatus.status === 'stopped',
                                                'text-red-600 dark:text-red-400': mqttStatus.status === 'unknown' || mqttStatus.status === 'error'
                                            }">
                                                {{
                                                mqttStatus.enabled ?
                                                (mqttStatus.status === 'running' ? 'Running' :
                                                mqttStatus.status === 'connecting' ? 'Connecting' :
                                                mqttStatus.status === 'reconnecting' ? 'Reconnecting' :
                                                mqttStatus.status === 'starting' ? 'Starting' :
                                                mqttStatus.status === 'error' ? 'Error' :
                                                mqttStatus.status === 'disconnected' ? 'Disconnected' :
                                                'Unknown') : 'Disabled'
                                                }}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6">
                                    <div class="flex items-center">
                                        <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900">
                                            <i class="fas fa-paper-plane text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Zabbix Sends</p>
                                            <p class="text-xl lg:text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.zabbix_sends || 0 }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Input Section -->
                        <div class="mx-4 lg:mx-6 bg-white dark:bg-gray-800 rounded-lg shadow mb-4">
                            <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Manual Zabbix Data Input</h3>
                            </div>
                            <div class="p-4">
                                <!-- Tab Navigation -->
                                <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
                                    <nav class="-mb-px flex space-x-4 lg:space-x-8 overflow-x-auto">
                                        <button @click="activeManualInputTab = 'json'" :class="[
                                            'py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap',
                                            activeManualInputTab === 'json'
                                                ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                                                : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                                        ]">
                                            JSON Input
                                        </button>
                                        <button @click="activeManualInputTab = 'form'" :class="[
                                            'py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap',
                                            activeManualInputTab === 'form'
                                                ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                                                : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                                        ]">
                                            Form Input
                                        </button>
                                    </nav>
                                </div>

                                <!-- JSON Input Tab Content -->
                                <div v-show="activeManualInputTab === 'json'">
                                    <div class="flex flex-col sm:flex-row gap-3">
                                        <input v-model="manualJsonInput" type="text" placeholder="Enter JSON string manually..."
                                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <button @click="processManualJson" :disabled="!manualJsonInput.trim()"
                                            class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-md transition-colors duration-200 whitespace-nowrap">
                                            Process JSON
                                        </button>
                                    </div>
                                </div>

                                <!-- Form Input Tab Content -->
                                <div v-show="activeManualInputTab === 'form'">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Zabbix Server IP</label>
                                            <input v-model="manualFormInput.zabbix_server_ip" type="text" placeholder="e.g., 192.168.1.1"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Zabbix Server Port</label>
                                            <input v-model.number="manualFormInput.zabbix_server_port" type="number" placeholder="e.g., 10051"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Item Host Name</label>
                                            <input v-model="manualFormInput.item_host_name" type="text" placeholder="e.g., my-server"
                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        </div>
                                    </div>

                                    <div class="flex items-center justify-between mb-2">
                                        <h4 class="text-md font-medium text-gray-900 dark:text-white">Items</h4>
                                        <button @click="addManualFormItem" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md flex items-center space-x-1 text-sm">
                                            <svg class="w-4 h-4 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
                                            </svg>
                                            <span>Add Item</span>
                                        </button>
                                    </div>
                                    <div v-for="(item, index) in manualFormInput.items" :key="index" class="flex gap-2 mb-2">
                                        <input v-model="item.key" type="text" placeholder="Key"
                                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <input v-model.number="item.value" type="number" placeholder="Value"
                                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <button @click="removeManualFormItem(index)" class="p-2 text-red-600 hover:text-red-700">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>

                                    <button @click="processManualForm" :disabled="isProcessFormDisabled"
                                        class="px-6 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-md transition-colors duration-200 whitespace-nowrap">
                                        Process Form Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Real-time Console - Full Height -->
                        <div class="flex-1 flex flex-col mx-4 lg:mx-6 bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden mb-4">
                            <div class="flex-shrink-0 p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">Real-time Activity</h3>
                                <button @click="clearMessagesLocalAndServer" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-md text-sm">
                                    Clear All
                                </button>
                            </div>
                            <div class="flex-1 p-4 overflow-hidden">
                                <div ref="consoleContainer" class="h-full overflow-y-auto bg-gray-50 dark:bg-gray-700 rounded p-4 font-mono text-xs lg:text-sm">
                                    <div v-if="messages.length === 0" class="text-gray-500 dark:text-gray-400">
                                        No messages yet...
                                    </div>
                                    <template v-for="(message, index) in messages" :key="index">
                                        <div v-if="message.type === 'timestamp'" class="mb-1 break-words" style="line-height: 1.4;">
                                            <div v-if="getRequestNumber(index) > 1" class="h-4"></div> <!-- Add an empty div for spacing -->
                                            <span class="inline-flex items-center px-1.5 py-0.5 text-xs font-mono rounded text-nowrap bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-200">
                                                <span class="mr-2">#{{ getRequestNumber(index) }}</span>
                                                <span>{{ formatTimestamp(message.content) }}</span>
                                            </span>
                                        </div>
                                        <div v-else :class="getMessageClasses(message.type)" class="mb-1 break-words p-1 rounded" style="line-height: 1.4;">
                                           {{ message.content }}
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration View -->
                    <div v-show="currentView === 'config'" class="flex flex-col h-full overflow-hidden">
                        <div class="flex-1 overflow-y-auto p-4 lg:p-6">
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Configuration</h2>
                                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Manage system settings</p>
                            </div>

                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                <form @submit.prevent="saveConfig" class="p-4 lg:p-6 space-y-6">
                                    <!-- HTTP Settings -->
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">HTTP Settings</h3>
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Port</label>
                                                <input v-model.number="config.http.port" type="number"
                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Divider -->
                                    <hr class="border-gray-200 dark:border-gray-700">

                                    <!-- MQTT Settings -->
                                    <div>
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">MQTT Settings</h3>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="flex items-center">
                                                    <input v-model="config.mqtt.enabled" type="checkbox" class="rounded border-gray-300 dark:border-gray-600">
                                                    <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Enable MQTT</span>
                                                </label>
                                            </div>

                                            <div v-if="config.mqtt.enabled" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Broker URL</label>
                                                    <input v-model="config.mqtt.url" type="text"
                                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                        placeholder="mqtts://broker.hivemq.cloud:8883">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Client ID</label>
                                                    <input v-model="config.mqtt.id" type="text"
                                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                        placeholder="client-id">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                                                    <input v-model="config.mqtt.login" type="text"
                                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                        placeholder="mqtt-username">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                                                    <input v-model="config.mqtt.password" type="password"
                                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                        placeholder="mqtt-password">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Topic</label>
                                                    <input v-model="config.mqtt.topic" type="text"
                                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                        placeholder="zabbix/test">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Period (seconds)</label>
                                                    <input v-model.number="config.mqtt.period" type="number" min="0"
                                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                                        placeholder="0">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3">
                                        <button type="button" @click="testConfig"
                                            class="px-4 py-2 border border-gray-300 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                                            Test Configuration
                                        </button>
                                        <button type="submit" :disabled="isSaving" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
                                            {{ isSaving ? 'Saving...' : 'Save Configuration' }}
                                        </button>
                                    </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Management View -->
                    <div v-show="currentView === 'users'" class="flex flex-col h-full overflow-hidden">
                        <div class="flex-1 overflow-y-auto p-4 lg:p-6">
                            <div class="mb-6">
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Users & Tokens</h2>
                                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Manage users and API tokens</p>
                            </div>

                            <!-- Tab Navigation -->
                            <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                                <nav class="-mb-px flex space-x-4 lg:space-x-8 overflow-x-auto">
                                    <button @click="activeTab = 'users'" :class="[
                                        'py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap',
                                        activeTab === 'users'
                                            ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                                            : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                                    ]">
                                        Users
                                    </button>
                                    <button @click="activeTab = 'tokens'" :class="[
                                        'py-2 px-1 border-b-2 font-medium text-sm whitespace-nowrap',
                                        activeTab === 'tokens'
                                            ? 'border-blue-500 text-blue-600 dark:text-blue-400'
                                            : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'
                                    ]">
                                        API Tokens
                                    </button>
                                </nav>
                            </div>

                            <!-- Users Tab -->
                            <div v-show="activeTab === 'users'">
                                <!-- Add User Form -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6 mb-6">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Add New User</h3>
                                    <form @submit.prevent="addUser" class="flex flex-col lg:flex-row lg:items-center">
                                        <input v-model="newUser.username" type="text" placeholder="Username" required
                                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white mr-4 mb-4 lg:mb-0 lg:mr-4">
                                        <input v-model="newUser.password" type="password" placeholder="Password" required
                                            class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white mr-4 mb-4 lg:mb-0 lg:mr-4">
                                        <button type="button" :disabled="isAddingUser" @click="addUser"
                                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 whitespace-nowrap">
                                            {{ isAddingUser ? 'Adding...' : 'Add User' }}
                                        </button>
                                    </form>
                                </div>


                                <!-- Users List -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Users</h3>
                                    </div>
                                    <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <div v-if="users.length === 0" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                            No users found. Add your first user above.
                                        </div>
                                        <div v-for="user in users" :key="user.id" class="px-4 lg:px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ user.username }}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400 truncate">Created: {{ formatDate(user.created_at) }}</p>
                                            </div>
                                            <div class="flex space-x-3">
                                                <button @click="editUser(user)" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                                                    Edit
                                                </button>
                                                <button @click="deleteUser(user.id)" class="text-red-600 hover:text-red-700 text-sm font-medium" v-if="user.username !== 'admin'">
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- API Tokens Tab -->
                            <div v-show="activeTab === 'tokens'">
                                <!-- Generate Token Form -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 lg:p-6 mb-6">
                                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Generate API Token</h3>
                                    <form @submit.prevent="generateToken" class="flex flex-col sm:flex-row sm:items-end gap-3 sm:gap-4">
                                        <div class="flex-1">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:hidden">Token Name</label>
                                            <input v-model="newToken.name" type="text" placeholder="Token Name" required
                                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm sm:text-base">
                                        </div>
                                        <div class="flex-1 sm:flex-initial sm:min-w-[140px]">
                                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:hidden">Expires In</label>
                                            <select v-model="newToken.expires_in"
                                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm sm:text-base">
                                                <option value="30">30 days</option>
                                                <option value="90">90 days</option>
                                                <option value="365">1 year</option>
                                                <option value="0">Never expires</option>
                                            </select>
                                        </div>
                                        <button type="submit" :disabled="isGeneratingToken"
                                            class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 text-sm sm:text-base whitespace-nowrap">
                                            {{ isGeneratingToken ? 'Generating...' : 'Generate Token' }}
                                        </button>
                                    </form>
                                </div>

                                <!-- New Token Display -->
                                <div v-if="generatedToken" class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-4 mb-6">
                                    <h4 class="text-lg font-medium text-green-800 dark:text-green-200 mb-2">New API Token Generated</h4>
                                    <p class="text-sm text-green-700 dark:text-green-300 mb-2">Copy this token now - it won't be shown again:</p>
                                    <div class="bg-white dark:bg-gray-800 border rounded p-3 font-mono text-sm break-all text-gray-900 dark:text-gray-100">
                                        {{ generatedToken }}
                                    </div>
                                    <button @click="copyToken" class="mt-2 text-sm text-green-600 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300">
                                        <i class="fas fa-copy mr-1"></i>
                                        Copy to clipboard
                                    </button>
                                </div>

                                <!-- Tokens List -->
                                <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">API Tokens</h3>
                                    </div>
                                    <div class="divide-y divide-gray-200 dark:divide-gray-700">
                                        <div v-if="tokens.length === 0" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                            No API tokens found. Generate your first token above.
                                        </div>
                                        <div v-for="token in tokens" :key="token.id" class="px-6 py-4 flex items-center justify-between">
                                            <div>
                                                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ token.name }}</p>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                                    Created: {{ formatDate(token.created_at) }}
                                                    <span v-if="token.expires_at"> | Expires: {{ formatDate(token.expires_at) }}</span>
                                                    <span v-else> | Never expires</span>
                                                </p>
                                                <p class="text-xs font-mono text-gray-400 dark:text-gray-500">{{ token.token_preview }}...</p>
                                            </div>
                                            <div class="flex items-center space-x-3">
                                                <span :class="[
                                                    'px-2 py-1 text-xs rounded-full',
                                                    token.is_active
                                                        ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'
                                                        : 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200'
                                                ]">
                                                    {{ token.is_active ? 'Active' : 'Expired' }}
                                                </span>
                                                <button @click="revokeToken(token.id)" class="text-red-600 hover:text-red-700 text-sm font-medium">
                                                    Revoke
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Notification Toasts -->
        <div class="fixed top-5 right-5 z-50 space-y-3 w-80">
            <div v-for="notification in notifications" :key="notification.id"
                :class="['p-4 rounded-lg shadow-lg flex items-start transition-all duration-300', notification.type === 'success' ? 'bg-green-100 dark:bg-green-900 border border-green-200 dark:border-green-700' : 'bg-red-100 dark:bg-red-900 border border-red-200 dark:border-red-700']">
                <i
                    :class="['mr-3 text-lg', notification.type === 'success' ? 'fas fa-check-circle text-green-600 dark:text-green-400' : 'fas fa-exclamation-circle text-red-600 dark:text-red-400']"></i>
                <div class="flex-1">
                    <p :class="['font-medium', notification.type === 'success' ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200']">{{ notification.title }}</p>
                    <p :class="['text-sm', notification.type === 'success' ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300']">{{ notification.message }}</p>
                </div>
                <button @click="dismissNotification(notification.id)" class="ml-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Modal -->
        <div v-if="modal.show" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                        </div>
                        <div class="ml-4 text-left">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">{{ modal.title }}</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ modal.message }}</p>
                                <div v-if="modal.type === 'prompt'" class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ modal.inputLabel }}</label>
                                    <input v-model="modal.inputValue" @keyup.enter="modal.onConfirm(modal.inputValue)" type="text"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-6 py-3 flex flex-row-reverse space-x-2 space-x-reverse">
                    <button @click="modal.onConfirm(modal.inputValue)" type="button" :class="['px-4 py-2 text-white rounded-md', modal.confirmClass || 'bg-red-600 hover:bg-red-700']">
                        {{ modal.confirmText || 'Confirm' }}
                    </button>
                    <button @click="modal.show = false" type="button"
                        class="px-4 py-2 bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-200 border border-gray-300 dark:border-gray-500 rounded-md hover:bg-gray-50 dark:hover:bg-gray-500">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Notifications
                    notifications: [],
                    notificationId: 0,

                    // Authentication state
                    isAuthenticated: false,
                    user: null,
                    token: null,
                    showUserMenu: false,

                    // Login form
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    isLoggingIn: false,
                    loginError: '',

                    // UI state
                    currentView: localStorage.getItem('zbx_current_view') || 'dashboard',
                    darkMode: localStorage.getItem('darkMode') === 'true',
                    sidebarOpen: false, // Mobile sidebar state

                    // Navigation
                    navigation: [
                        { name: 'Dashboard', key: 'dashboard', icon: 'fas fa-tachometer-alt' },
                        { name: 'Configuration', key: 'config', icon: 'fas fa-cog' },
                        { name: 'Users & Tokens', key: 'users', icon: 'fas fa-users' }
                    ],

                    // WebSocket
                    socket: null,
                    wsConnected: false,
                    messages: [],
                    manualJsonInput: '',
                    activeManualInputTab: localStorage.getItem('zbx_active_manual_input_tab') || 'json', // 'json' or 'form'
                    manualFormInput: {
                        zabbix_server_ip: '',
                        zabbix_server_port: 10051,
                        item_host_name: '',
                        items: [{ key: '', value: '' }]
                    },
                    localStorageKey: 'zbx_manual_form_data', // Key for localStorage

                    // Data
                    stats: {
                        total_requests: 0,
                        successful_requests: 0,
                        failed_requests: 0,
                        mqtt_messages: 0,
                        zabbix_sends: 0,
                        connected_clients: 0,
                        uptime: "0s",
                    },
                    config: {
                        http: { port: 7000 },
                        mqtt: {
                            enabled: false,
                            url: '',
                            id: '',
                            login: '',
                            password: '',
                            period: 0,
                            topic: ''
                        }
                    },
                    mqttStatus: {
                        enabled: false,
                        status: 'unknown',
                        url: '',
                        topic: ''
                    },
                    users: [],
                    tokens: [],

                    // Form data
                    newUser: { username: '', password: '' },
                    newToken: { name: '', expires_in: 30 },
                    generatedToken: null,

                    // Form states
                    isSaving: false,
                    isAddingUser: false,
                    isGeneratingToken: false,
                    activeTab: localStorage.getItem('zbx_active_tab') || 'users',

                    // Modal state
                    modal: {
                        show: false,
                        type: 'confirm', // 'confirm' or 'prompt'
                        title: '',
                        message: '',
                        inputValue: '',
                        inputLabel: '',
                        onConfirm: () => { },
                        confirmText: 'Confirm',
                        confirmClass: ''
                    }
                }
            },

            mounted() {
                this.applyDarkMode();
                this.checkAuthStatus();
                this.initWebSocket();
                this.loadManualFormData(); // Load saved data on mount

                // Click outside to close user menu
                document.addEventListener('click', this.handleClickOutside);
            },

            beforeUnmount() {
                document.removeEventListener('click', this.handleClickOutside);
            },

            watch: {
                currentView(newValue) {
                    localStorage.setItem('zbx_current_view', newValue);
                },
                activeManualInputTab(newValue) {
                    localStorage.setItem('zbx_active_manual_input_tab', newValue);
                },
                activeTab(newValue) {
                    localStorage.setItem('zbx_active_tab', newValue);
                }
            },

            methods: {
                // Authentication methods
                async handleLogin() {
                    this.isLoggingIn = true;
                    this.loginError = '';

                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            // Store authentication data
                            this.isAuthenticated = true;
                            this.user = { username: this.loginForm.username };

                            // Store in localStorage for persistence
                            localStorage.setItem('zbx_authenticated', 'true');
                            localStorage.setItem('zbx_user', JSON.stringify(this.user));

                            await this.loadInitialData();
                        } else {
                            this.loginError = data.message || 'Login failed';
                        }
                    } catch (error) {
                        this.loginError = 'Network error. Please try again.';
                        console.error('Login error:', error);
                    }

                    this.isLoggingIn = false;
                },

                async checkAuthStatus() {
                    const isAuth = localStorage.getItem('zbx_authenticated');
                    const userData = localStorage.getItem('zbx_user');

                    if (isAuth === 'true' && userData) {
                        try {
                            this.user = JSON.parse(userData);
                            this.isAuthenticated = true;
                            await this.loadInitialData();
                        } catch (error) {
                            console.error('Auth check error:', error);
                            this.logout();
                        }
                    }
                },

                logout() {
                    this.isAuthenticated = false;
                    this.user = null;
                    this.token = null;
                    this.showUserMenu = false;

                    localStorage.removeItem('zbx_authenticated');
                    localStorage.removeItem('zbx_user');
                    localStorage.removeItem('zbx_token');

                    if (this.socket) {
                        this.socket.close();
                    }
                },

                toggleUserMenu() {
                    this.showUserMenu = !this.showUserMenu;
                },

                handleClickOutside(event) {
                    const userMenuContainer = this.$refs.userMenuContainer;
                    if (userMenuContainer && !userMenuContainer.contains(event.target)) {
                        this.showUserMenu = false;
                    }
                },

                // API methods
                async apiRequest(url, options = {}) {
                    const response = await fetch(url, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });

                    return response;
                },

                async loadInitialData() {
                    await Promise.all([
                        this.loadConfig(),
                        this.loadStats(), // Ensure stats are loaded initially
                        this.loadUsers(),
                        this.loadTokens(),
                        this.loadMqttStatus() // Initial load only
                    ]);
                },

                async loadConfig() {
                    try {
                        const response = await this.apiRequest('/api/config');
                        if (response?.ok) {
                            this.config = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load config:', error);
                    }
                },

                async loadStats() {
                    try {
                        const response = await this.apiRequest('/api/stats');
                        if (response?.ok) {
                            this.stats = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },

                async loadUsers() {
                    try {
                        const response = await this.apiRequest('/api/users');
                        if (response?.ok) {
                            this.users = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load users:', error);
                    }
                },

                async loadTokens() {
                    try {
                        const response = await this.apiRequest('/api/tokens');
                        if (response?.ok) {
                            this.tokens = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load tokens:', error);
                    }
                },

                async loadMqttStatus() {
                    try {
                        const response = await this.apiRequest('/api/mqtt/status');
                        if (response?.ok) {
                            this.mqttStatus = await response.json();
                        }
                    } catch (error) {
                        console.error('Failed to load MQTT status:', error);
                    }
                },

                // User management methods
                async addUser() {
                    this.isAddingUser = true;
                    try {
                        const response = await this.apiRequest('/api/users', {
                            method: 'POST',
                            body: JSON.stringify(this.newUser)
                        });

                        if (response?.ok) {
                            const result = await response.json();

                            if (result.success) {
                                // Add user to local list
                                this.users.push(result.user);
                                this.newUser = { username: '', password: '' };
                                this.showNotification('Success', 'User added successfully!', 'success');
                            } else {
                                this.showNotification('Error', 'Failed to add user: ' + (result.error || 'Unknown error'), 'error');
                            }
                        } else {
                            const error = await response.json();

                            if (response.status === 409) {
                                this.showNotification('Error', 'Username already exists!', 'error');
                            } else {
                                this.showNotification('Error', 'Failed to add user: ' + (error.error || 'Unknown error'), 'error');
                            }
                        }
                    } catch (error) {
                        this.showNotification('Error', 'Failed to add user: ' + error.message, 'error');
                    }
                    this.isAddingUser = false;
                },

                editUser(user) {
                    this.showModal({
                        type: 'prompt',
                        title: 'Edit User',
                        message: `Enter a new username for ${user.username}.`,
                        inputLabel: 'New Username',
                        inputValue: user.username,
                        confirmText: 'Update',
                        confirmClass: 'bg-blue-600 hover:bg-blue-700',
                        onConfirm: (newUsername) => {
                            if (newUsername && newUsername !== user.username) {
                                // NOTE: In a real app, you'd make an API call to update the user on the server.
                                // For this example, we optimistically update the UI.
                                user.username = newUsername;
                                this.showNotification('Success', 'User updated successfully!', 'success');
                            }
                            this.modal.show = false;
                        }
                    });
                },

                deleteUser(userId) {
                    this.showModal({
                        type: 'confirm', // Explicitly set type to 'confirm'
                        title: 'Delete User',
                        message: 'Are you sure you want to delete this user? This action cannot be undone.',
                        confirmText: 'Delete',
                        confirmClass: 'bg-red-600 hover:bg-red-700',
                        onConfirm: async () => {
                            this.modal.show = false;
                            try {
                                const response = await this.apiRequest(`/api/users/${userId}`, {
                                    method: 'DELETE'
                                });
                                if (response.ok) {
                                    const result = await response.json();
                                    if (result.success) {
                                        this.users = this.users.filter(u => u.id !== userId);
                                        this.showNotification('Success', 'User deleted successfully!', 'success');
                                    } else {
                                        this.showNotification('Error', result.error || 'Failed to delete user', 'error');
                                    }
                                } else {
                                    const error = await response.json();
                                    this.showNotification('Error', error.error || `HTTP ${response.status}`, 'error');
                                }
                            } catch (error) {
                                this.showNotification('Error', 'Failed to delete user: ' + error.message, 'error');
                            }
                        }
                    });
                },

                // Token management methods
                async generateToken() {
                    this.isGeneratingToken = true;
                    this.generatedToken = null;

                    try {
                        const response = await this.apiRequest('/api/tokens', {
                            method: 'POST',
                            body: JSON.stringify(this.newToken)
                        });

                        if (response?.ok) {
                            // Generate a mock token for demonstration
                            const mockToken = 'zbx_' + Math.random().toString(36).substr(2, 32);
                            this.generatedToken = mockToken;

                            // Add to tokens list
                            const newTokenId = this.tokens.length + 1;
                            const expiresAt = this.newToken.expires_in > 0
                                ? new Date(Date.now() + this.newToken.expires_in * 24 * 60 * 60 * 1000).toISOString()
                                : null;

                            this.tokens.push({
                                id: newTokenId,
                                name: this.newToken.name,
                                token_preview: mockToken.substr(0, 8),
                                created_at: new Date().toISOString(),
                                expires_at: expiresAt,
                                is_active: true
                            });

                            this.newToken = { name: '', expires_in: 30 };
                        } else {
                            const error = await response.json();
                            this.showNotification('Error', 'Failed to generate token: ' + (error.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error', 'Failed to generate token: ' + error.message, 'error');
                    }
                    this.isGeneratingToken = false;
                },

                revokeToken(tokenId) {
                    this.showModal({
                        title: 'Revoke Token',
                        message: 'Are you sure you want to revoke this API token? It will no longer be usable.',
                        confirmText: 'Revoke',
                        onConfirm: async () => {
                            this.modal.show = false;
                            try {
                                const response = await this.apiRequest(`/api/tokens/${tokenId}`, {
                                    method: 'DELETE'
                                });
                                if (response.ok) {
                                    this.tokens = this.tokens.filter(t => t.id !== tokenId);
                                    this.showNotification('Success', 'Token revoked successfully!', 'success');
                                } else {
                                    this.showNotification('Error', 'Failed to revoke token.', 'error');
                                }
                            } catch (error) {
                                this.showNotification('Error', 'Failed to revoke token: ' + error.message, 'error');
                            }
                        }
                    });
                },

                copyToken() {
                    if (this.generatedToken) {
                        navigator.clipboard.writeText(this.generatedToken).then(() => {
                            this.showNotification('Success', 'Token copied to clipboard!', 'success');
                        }).catch(() => {
                            this.showNotification('Error', 'Failed to copy token. Please copy manually.', 'error');
                        });
                    }
                },

                async saveConfig() {
                    this.isSaving = true;
                    try {
                        const response = await this.apiRequest('/api/config', {
                            method: 'PUT',
                            body: JSON.stringify(this.config)
                        });

                        if (response?.ok) {
                            this.showNotification('Success', 'Configuration saved successfully!', 'success');
                            // MQTT status will be updated automatically via WebSocket
                        } else {
                            const error = await response.json();
                            this.showNotification('Error', 'Failed to save configuration: ' + error.error, 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error', 'Failed to save configuration: ' + error.message, 'error');
                    }
                    this.isSaving = false;
                },

                async testConfig() {
                    try {
                        const response = await this.apiRequest('/api/config/test', {
                            method: 'POST',
                            body: JSON.stringify(this.config)
                        });

                        if (response?.ok) {
                            const result = await response.json();
                            this.showNotification('Info', 'Configuration test completed. Check console for details.', 'success');
                            console.log('Test results:', result);
                        }
                    } catch (error) {
                        this.showNotification('Error', 'Failed to test configuration: ' + error.message, 'error');
                    }
                },

                // WebSocket methods
                initWebSocket() {
                    // Use port 2794 for WebSocket connection as in the Rust version
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const host = window.location.hostname;
                    const wsUrl = `${protocol}//${host}:2794`;

                    try {
                        this.socket = new WebSocket(wsUrl, 'rust-websocket');

                        this.socket.onopen = () => {
                            this.wsConnected = true;
                            console.log('WebSocket connected');
                        };

                        this.socket.onmessage = (event) => {
                            try {
                                const message = JSON.parse(event.data); // All messages are now JSON objects

                                if (message.type === 'mqtt_status') {
                                    this.mqttStatus = message.data;
                                    console.log('MQTT status updated via WebSocket:', this.mqttStatus);
                                } else if (message.type === 'stats') {
                                    this.stats = message.data;
                                }
                                else {
                                    this.messages.push(message); // Push the entire message object
                                    if (this.messages.length > 150) {
                                        this.messages = this.messages.slice(-150);
                                    }
                                    this.scrollToBottom();
                                }
                            } catch (e) {
                                console.error('Error parsing WebSocket message:', e, event.data);
                                // Fallback for malformed JSON, treat as plain text error
                                if (event.data.trim()) {
                                    this.messages.push({ type: 'error', content: event.data });
                                    if (this.messages.length > 150) {
                                        this.messages = this.messages.slice(-150);
                                    }
                                    this.scrollToBottom();
                                }
                            }
                        };

                        this.socket.onclose = () => {
                            this.wsConnected = false;
                            console.log('WebSocket disconnected');
                            // Reconnect after 5 seconds
                            setTimeout(() => this.initWebSocket(), 5000);
                        };

                        this.socket.onerror = (error) => {
                            console.error('WebSocket error:', error);
                            this.wsConnected = false;
                        };
                    } catch (error) {
                        console.error('Failed to create WebSocket:', error);
                    }
                },

                // Notification methods
                showNotification(title, message, type = 'info') {
                    const id = this.notificationId++;
                    this.notifications.push({ id, title, message, type });

                    setTimeout(() => {
                        this.dismissNotification(id);
                    }, 5000); // Auto-dismiss after 5 seconds
                },

                dismissNotification(id) {
                    const index = this.notifications.findIndex(n => n.id === id);
                    if (index !== -1) {
                        this.notifications.splice(index, 1);
                    }
                },

                // Modal methods
                showModal(options) {
                    this.modal = { ...this.modal, ...options, show: true };
                },

                // UI methods
                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('darkMode', this.darkMode);
                    this.applyDarkMode();
                },

                applyDarkMode() {
                    if (this.darkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },

                isTimestampMessage(message) { // Keep for getRequestNumber
                    const timestampRegex = /^\[\d{2}:\d{2}:\d{2} \d{2}-\d{2}-\d{4}\]$/;
                    return timestampRegex.test(message.content);
                },

                formatTimestamp(content) {
                    return content.slice(1, -1);
                },

                getMessageClasses(type) {
                    const baseClasses = 'p-1 rounded ';
                    switch (type) {
                        case 'http-get': // Green
                            return 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                        case 'http-post': // Yellow
                            return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                        case 'manual-input-source': // Yellow
                            return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                        case 'error': // Errors should still be highlighted
                            return 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200';
                        default:
                            return 'text-gray-800 dark:text-gray-200'; // Default for all other types
                    }
                },

                getRequestNumber(timestampIndex) {
                    // Count the number of timestamp messages up to and including this one
                    let requestCount = 0;
                    for (let i = 0; i <= timestampIndex; i++) {
                        if (this.isTimestampMessage(this.messages[i])) {
                            requestCount++;
                        }
                    }
                    return requestCount;
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        if (this.$refs.consoleContainer) {
                            this.$refs.consoleContainer.scrollTop = this.$refs.consoleContainer.scrollHeight;
                        }
                    });
                },

                // Manual JSON Input processing method
                async processManualJson() {
                    if (!this.manualJsonInput.trim()) {
                        this.showNotification('Warning', 'Please enter a JSON string', 'error');
                        return;
                    }

                    try {
                        // Try to parse the JSON to validate it
                        const parsedJson = JSON.parse(this.manualJsonInput);


                        // Send JSON to Zabbix server
                        try {
                            const response = await this.apiRequest('/api/zabbix/manual', {
                                method: 'POST',
                                body: JSON.stringify(parsedJson)
                            });

                            if (response?.ok) {
                                const result = await response.json();
                                this.messages.push(`Zabbix Response: ${JSON.stringify(result, null, 2)}`);
                                this.showNotification('Success', 'Data sent to Zabbix successfully!', 'success');
                            } else {
                                const errorData = await response.json();
                                this.messages.push(`Zabbix Error: ${JSON.stringify(errorData, null, 2)}`);
                                this.showNotification('Error', 'Failed to send data to Zabbix: ' + (errorData.error || 'Unknown error'), 'error');
                            }
                        } catch (zabbixError) {
                            this.messages.push(`Zabbix Send Error: ${zabbixError.message}`);
                            this.showNotification('Error', 'Failed to send data to Zabbix: ' + zabbixError.message, 'error');
                        }

                        // Keep message limit
                        if (this.messages.length > 150) {
                            this.messages = this.messages.slice(-150);
                        }

                        // Clear input and scroll to bottom
                        this.manualJsonInput = '';
                        this.scrollToBottom();

                    } catch (error) {
                        this.showNotification('Error', 'Invalid JSON format: ' + error.message, 'error');
                    }
                },

                formatDate(dateString) {
                    return new Date(dateString).toLocaleString();
                },

                async clearMessagesLocalAndServer() {
                    this.messages = []; // Clear local messages
                    try {
                        const response = await this.apiRequest('/api/logs/clear', { method: 'POST' });
                        if (response.ok) {
                            this.showNotification('Success', 'Server logs cleared successfully!', 'success');
                        } else {
                            let errorMessage = 'Unknown error';
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.error || errorData.message || 'Unknown error';
                            } catch (e) {
                                errorMessage = response.statusText || 'Failed to parse error response';
                            }
                            this.showNotification('Error', 'Failed to clear server logs: ' + errorMessage, 'error');
                        }
                    } catch (error) {
                        this.showNotification('Error', 'Network error while clearing server logs: ' + error.message, 'error');
                    }
                },

                // Manual Form Input methods
                addManualFormItem() {
                    this.manualFormInput.items.push({ key: '', value: '' });
                },
                removeManualFormItem(index) {
                    this.manualFormInput.items.splice(index, 1);
                },
                async processManualForm() {
                    const { zabbix_server_ip, zabbix_server_port, item_host_name, items } = this.manualFormInput;

                    // Save current form data to localStorage
                    localStorage.setItem(this.localStorageKey, JSON.stringify(this.manualFormInput));

                    if (!zabbix_server_ip || !item_host_name || items.length === 0) {
                        this.showNotification('Warning', 'Please fill in all required fields and add at least one item.', 'error');
                        return;
                    }

                    const parsedItems = items.map(item => ({
                        key: item.key,
                        value: parseFloat(item.value) // Ensure value is a number
                    }));

                    const payload = {
                        zabbix_server_ip,
                        zabbix_server_port,
                        item_host_name,
                        item: parsedItems.filter(item => !isNaN(item.value)) // Filter out items with non-numeric values
                    };

                    if (payload.item.length === 0) {
                        this.showNotification('Warning', 'No valid numeric items to send. Please check item values.', 'error');
                        return;
                    }

                    try {
                        const response = await this.apiRequest('/api/zabbix/manual', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });

                        if (response?.ok) {
                            const result = await response.json();
                            this.messages.push({ type: 'zabbix-response', content: `Zabbix Response: ${JSON.stringify(result, null, 2)}` });
                            this.showNotification('Success', 'Data sent to Zabbix successfully!', 'success');
                        } else {
                            const errorData = await response.json();
                            this.messages.push({ type: 'error', content: `Zabbix Error: ${JSON.stringify(errorData, null, 2)}` });
                            this.showNotification('Error', 'Failed to send data to Zabbix: ' + (errorData.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        this.messages.push({ type: 'error', content: `Zabbix Send Error: ${error.message}` });
                        this.showNotification('Error', 'Failed to send data to Zabbix: ' + error.message, 'error');
                    } finally {
                        this.scrollToBottom();
                    }
                },

                loadManualFormData() {
                    try {
                        const savedData = localStorage.getItem(this.localStorageKey);
                        if (savedData) {
                            const parsedData = JSON.parse(savedData);
                            // Ensure items array is always present and has at least one empty item if empty
                            if (!parsedData.items || parsedData.items.length === 0) {
                                parsedData.items = [{ key: '', value: '' }];
                            }
                            this.manualFormInput = parsedData;
                        }
                    } catch (e) {
                        console.error("Failed to load manual form data from localStorage:", e);
                        localStorage.removeItem(this.localStorageKey); // Clear corrupted data
                    }
                }
            },
            computed: {
                isProcessFormDisabled() {
                    const { zabbix_server_ip, zabbix_server_port, item_host_name, items } = this.manualFormInput;
                    if (!zabbix_server_ip || !zabbix_server_port || !item_host_name || items.length === 0) {
                        return true;
                    }
                    // Check if all items have non-empty key and value
                    return items.some(item => !item.key.trim() || item.value === '' || isNaN(item.value));
                }
            }
        }).mount('#app');
    </script>
</body>

</html>